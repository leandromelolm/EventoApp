<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head th:replace="fragments :: html_head" />

<body>

	<div th:replace="fragments :: menu" />
	
	<div class="container">
	
	<!-- INFORMAÇÕES DA CONTA -->
		<div sec:authorize="isAuthenticated()">
			<h4>Minha Conta</h4>
			<p>Email: <b>[[${#authentication.name}]]</b></p>
			<p>Nome: <b>[[${session.mySessionNome}]]</b></p>
			<p>CPF: <b>[[${session.mySessionCpf}]]</b></p>
			<p>Data do Cadastro: <b>[[${#dates.format(session.mySessionDataCadastro,'dd-MM-yyyy HH:mm')}]]</b></p>
			<p>Perfil Usuário: <b>[[${session.mySessionTipoPerfil}]]</b></p>
			<p class="hide">Conta Ativa: <b>[[${session.mySessionUsuarioAtivo}]]</b></p>						
			<p class="hide" >Id: <b>[[${session.mySessionId}]]</b></p>
		</div>
		
		<p id="acessoUsuario"></p>
		
		<div id="infominhaconta"></div>
		
		<p th:if="${session.mySessionNome == null}">
			Se as informações da conta não aparecerem <a onclick="window.location.reload()"> Clique aqui</a> ou no botão Atualizar Página
		</p>
		<span th:if="${session.mySessionNome == null}"> 
			<button class="waves-effect waves-light btn input-field" type="submit" onClick="window.location.reload()"> Atualizar Página</button>
		</span>		
	
	<!-- BOTÕES SAIR ENTRAR CADASTRAR -->
		<div>
			<div>
				</p>
				<a id="btncadastrar" href="/cadastrarEvento" class="waves-effect waves-light btn">Cadastrar Evento</a>				
				</p>
				<a onclick="return confirmaDeslogar();" sec:authorize="isAuthenticated()" href="/logout"
					class="waves-effect waves-light btn">Logout</a>
				<a id="btncadastrar" href="/login.html" sec:authorize="!isAuthenticated()"
					class="waves-effect waves-light btn">Entrar</a>
				<a id="btncadastrar" href="/register" sec:authorize="!isAuthenticated()"
					class="waves-effect waves-light btn">Cadastre-se</a>
			</div>				
		</div>
		
		<div>
			<form name="formulario" id="formulario" class="formulario" method="get">
				<div class="hide">
					User Logado:<input id="formEmailUser" name="emailResponsavelEvento" th:value="${#authentication.name}"
						readonly=true />
				</div>
				<button  class="hide  waves-effect waves-light btn input-field" type="submit"> METHOD GET Email</button >
			</form>
		</div>

	<!-- FORM POST EXCLUIR CONTA -->
		<div sec:authorize="isAuthenticated()">	
				
			<th:block th:include="mensagemValidacao"></th:block>
						
			<form action="#" name="formExcluir" th:action="@{/deletarMinhaContaUsuario}" method="POST">
				<input class="hide" readonly=true id="id" name="id" th:value="${session.mySessionId}"/>
				<input class="hide" readonly=true id="email" name="email" th:Quantidade de eventos cadastrados:value="${#authentication.name}">
				<p/>
				<span th:unless="${session.mySessionNome == null}">
					<button type="submit" class="btn red" onclick="return confirmarExcluir()">
						<i class="material-icons">delete_forever</i>
						EXCLUIR CONTA
					</button>
				</span>				
			</form>
		</div>			
			
			
		<div id="admin" sec:authorize="hasRole('ADMIN')">					
			<div>
				<p id="userAdmin"></p>				
			</div>	
		</div>
	</div>
	
	<!--JavaScript at end of body for optimized loading-->
  	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="/materialize/js/materialize.min.js"></script>
	<script type="text/javascript" src="/materialize/js/materialize.js"></script>
	<script type="text/javascript" src="/js/main.js"></script>

	<script type="text/javascript">
	
		window.onload = function () {
			console.log("function called page minha-conta...");	
			let stringEmail = document.getElementById("formEmailUser").value
			
			var quantEventos =  '[[${session.userQuantEventos}]]';
			var cpf =  '[[${session.mySessionCpf}]]';
			var atualAcesso = "[[${#dates.format(session.atualAcesso,'dd-MM-yyyy HH:mm:ss z ZZZ')}]]";
			var ultimoAcesso = "[[${#dates.format(session.ultimoAcesso,'dd-MM-yyyy HH:mm:ss z ZZZ')}]]";
			
			var dtAtualAcesso = new Date("[[${#dates.formatISO(session.atualAcesso)}]]");
			var dtUltAcesso = new Date("[[${#dates.formatISO(session.ultimoAcesso)}]]");
			
			if(!cpf){
				console.log("ajax post")
				$.ajax({
 		 			type: "POST",
 		 			url: "/info-user-logged",
  					data: stringEmail,
  					dataType: "text",
  					success: function(){
						console.log("POST success minhaconta");
						window.location.reload();						
        			}
				});	
			}
			
			console.log("ok!")							
			document.getElementById("infominhaconta").innerHTML = "Sua quantidade de eventos: <b> "+quantEventos+"</b>"
								+"<p/>Para excluir sua conta é necessário deletar todos os seus eventos que estejam cadastrados.";	
			const elementDiv = document.getElementById("acessoUsuario");						
			setTimeout(function() {						
				elementDiv.innerHTML += "Atual Acesso: <b>" + dtAtualAcesso.toLocaleString() + "</b> <p/>"+
										"Ultimo Acesso: <b>" + dtUltAcesso.toLocaleString() + "</b> <p/>"},1);	
										
			const element = document.getElementById("userAdmin");						
			setTimeout(function() {						
				element.innerHTML += "Atual Acesso (GMT): <b>" + atualAcesso + "</b> <p/>"+
									"Ultimo Acesso (GMT): <b>" + ultimoAcesso + "</b> <p/>"},1000);											   	
		}
		
		function confirmarExcluir() {
			var resultado = (confirm('Tem certeza que você quer excluir sua Conta? Sua conta será deslogada e seus dados apagados. Para acessar novamente você precisará fazer um novo cadastro.'))
			if (resultado == true) {
				alert("Clique em OK para Excluir sua conta!")
				return true;				
			}else {				
				return false;
			}
		}
				
	</script>
</body>

</html>